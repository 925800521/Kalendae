/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2012 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.1                                                     *
 ********************************************************************/

(function(){var p=function(a){var b=this,e=b.classes,d=b.settings=f.merge(b.defaults,a),a=b.container=f.make("div",{"class":e.container}),j=b.calendars=[],o=l().day(d.weekStart),m,p=[],n,k,g;n=[];var C;k=0;m=d.months;for(k=7;k--;)p.push(o.format("ddd").substr(0,d.columnHeaderLength)),o.add("days",1);z(b);if("object"===typeof d.subscribe)for(k in d.subscribe)d.subscribe.hasOwnProperty(k)&&b.subscribe(k,d.subscribe[k]);b._sel=[];d.selected&&b.setSelected(d.selected,!1);m=d.viewStartDate?l(d.viewStartDate,
d.format):0<b._sel.length?l(b._sel[0]):l();b.viewStartDate=m.date(1);if("function"===typeof d.blackout)b.blackout=d.blackout;else if(d.blackout){var s=y(d.blackout,d.parseSplitDelimiter);b.blackout=function(a){a=l(a).hours(0).minutes(0).seconds(0).valueOf();if(1>a||!b._sel||1>b._sel.length)return!1;for(var e=s.length;e--;)if(s[e].valueOf()===a)return!0;return!1}}else b.blackout=function(){return!1};for(m=Math.max(d.months,1);m--;){n=f.make("div",{"class":e.calendar},a);n.setAttribute("data-cal-index",
m);1<d.months&&(m==Math.max(d.months-1,1)?f.addClassName(n,e.monthFirst):0===m?f.addClassName(n,e.monthLast):f.addClassName(n,e.monthMiddle));k=f.make("div",{"class":e.title},n);f.make("a",{"class":e.previous},k);f.make("a",{"class":e.next},k);o=f.make("span",{"class":e.caption},k);g=f.make("div",{"class":e.header},n);k=0;do C=f.make("span",{},g),C.innerHTML=p[k];while(7>++k);g=f.make("div",{"class":e.days},n);k=0;for(n=[];42>k++;)n.push(f.make("span",{},g));j.push({caption:o,days:n});m&&f.make("div",
{"class":e.monthSeparator},a)}b.draw();f.addEvent(a,"mousedown",function(a,j){var g;if(f.hasClassName(j,e.next))!1!==b.publish("view-changed",b,["next"])&&(b.viewStartDate.add("months",1),b.draw());else if(f.hasClassName(j,e.previous))!1!==b.publish("view-changed",b,["previous"])&&(b.viewStartDate.subtract("months",1),b.draw());else if(f.hasClassName(j.parentNode,e.days)&&f.hasClassName(j,e.dayActive)&&(g=j.getAttribute("data-date")))if(g=l(g,d.dayAttributeFormat),!1!==b.publish("date-clicked",b,
[g]))switch(d.mode){case "multiple":b.addSelected(g)||b.removeSelected(g);break;case "range":b.addSelected(g);break;default:b.addSelected(g)}a.preventDefault();return!0});(d.attachTo=f.$(d.attachTo))&&d.attachTo.appendChild(a)};p.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",viewStartDate:null,blackout:null,selected:null,mode:"single",format:null,subscribe:null,columnHeaderLength:2,titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s*-\s*/,
rangeDelimiter:" - ",multipleDelimiter:", "},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previous:"k-previous",next:"k-next",caption:"k-caption",header:"k-header",days:"k-days",dayOutOfMonth:"k-out-of-month",dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator"},getSelectedAsDates:function(){for(var a=[],b=0,e=this._sel.length;b<e;b++)a.push(this._sel[b].nativeDate());
return a},getSelectedAsText:function(a){for(var b=[],e=0,d=this._sel.length;e<d;e++)b.push(this._sel[e].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,e=this._sel.length;b<e;b++)a.push(l(this._sel[b]));return a},getSelected:function(a){a=this.getSelectedAsText(a);switch(this.settings.mode){case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);default:return a[0]}},isSelected:function(a){a=
l(a).hours(0).minutes(0).seconds(0).valueOf();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "range":var b=this._sel[0]?this._sel[0].valueOf():0,e=this._sel[1]?this._sel[1].valueOf():0;if(b===a||e===a)return 1;if(!b||!e)return 0;if(a>b&&a<e||b<e&&a<b&&a>e)return-1;break;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].valueOf()===a)return!0;break;default:return this._sel[0]&&this._sel[0].valueOf()===a}return!1},setSelected:function(a,b){this._sel=y(a,this.settings.parseSplitDelimiter);
this._sel.sort(function(a,b){return a.valueOf()-b.valueOf()});!1!==b&&this.draw()},addSelected:function(a,b){a=l(a).hours(0).minutes(0).seconds(0);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.valueOf()>this._sel[0].valueOf()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,b){return a.valueOf()-b.valueOf()});this.publish("change",this);!1!==b&&this.draw();
return!0},removeSelected:function(a,b){for(var a=l(a).hours(0).minutes(0).seconds(0).valueOf(),e=this._sel.length;e--;)if(this._sel[e].valueOf()===a)return this._sel.splice(e,1),this.publish("change",this),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=l(this.viewStartDate),b,e=l().hours(0).minutes(0).seconds(0),d=this.classes,j,f,m,p=0,n,k=0,g;n=this.calendars.length;do{b=l(a).date(1).day(this.settings.weekStart);j=this.calendars[p];j.caption.innerHTML=a.format(this.settings.titleFormat);
k=0;do f=j.days[k],m=[],(g=this.isSelected(b))&&m.push({"-1":d.dayInRange,1:d.daySelected,"true":d.daySelected}[g]),b.month()!=a.month()?m.push(d.dayOutOfMonth):(!this.blackout(b)||0<g)&&m.push(d.dayActive),0===Math.floor(e.diff(b,"days",!0))&&m.push(d.dayToday),f.innerHTML=b.format(this.settings.dayNumberFormat),f.className=m.join(" "),f.setAttribute("data-date",b.format(this.settings.dayAttributeFormat)),b.add("days",1);while(42>++k);a.add("months",1)}while(++p<n)}};var y=function(a,b){var e=[];
"string"===typeof a?a=a.split(b):unit.isArray(a)||(a=[sel_in]);c=a.length;i=0;do e.push(l(a[i]).hours(0).minutes(0).seconds(0));while(++i<c);return e};window.Kalendae=p;var f={$:function(a){return"string"==typeof a?document.getElementById(a):a},make:function(a,b,e){var d,a=document.createElement(a);if(b)for(d in b)b.hasOwnProperty(d)&&a.setAttribute(d,b[d]);e&&e.appendChild(a);return a},isVisible:function(a){return 0<a.offsetWidth||0<a.offsetHeight},addEvent:function(a,b,e){var d=function(b){b=b||
window.event;return e.apply(a,[b,b.target||b.srcElement])};a.attachEvent?a.attachEvent("on"+b,d):a.addEventListener(b,d,!1);return d},removeEvent:function(a,b,e){a.detachEvent?a.detachEvent("on"+b,e):a.removeEventListener(b,e,!1)},hasClassName:function(a,b){if(!(a=f.$(a)))return!1;var e=a.className;return 0<e.length&&(e==b||RegExp("(^|\\s)"+b+"(\\s|$)").test(e))},addClassName:function(a,b){if((a=f.$(a))&&!f.hasClassName(a,b))a.className+=(a.className?" ":"")+b},removeClassName:function(a,b){if(a=
f.$(a))a.className=f.trimString(a.className.replace(RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},getPosition:function(a,b){var e=a.offsetLeft,d=a.offsetTop,f={};if(!b)for(;a=a.offsetParent;)e+=a.offsetLeft,d+=a.offsetTop;f[0]=f.left=e;f[1]=f.top=d;return f},getHeight:function(a){return a.offsetHeight||a.scrollHeight},getWidth:function(a){return a.offsetWidth||a.scrollWidth},trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=!0===arguments[0],b={},e=a?1:0;e<
arguments.length;e++){var d=b,f=arguments[e];if("object"===typeof f){var o=void 0;for(o in f)f.hasOwnProperty(o)&&(a&&"object"===typeof d[o]&&"object"===typeof f[o]?_update(d[o],f[o]):d[o]=f[o])}}return b},isArray:function(a){return!(!a||!a.length||0===a.length||"object"!==typeof a||!a.constructor||a.nodeType||a.item)}};p.Input=function(a,b){this.input=$input=f.$(a);if(!$input||"INPUT"!==$input.tagName)throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";var e=
this,d=e.classes;opts=e.settings=f.merge(e.defaults,b);opts.attachTo=window.document.body;opts.selected||(opts.selected=$input.value);p.call(e,opts);var j=e.container;j.style.display="none";f.addClassName(j,d.positioned);f.addEvent($input,"focus",function(){e.setSelected(this.value);e.show()});f.addEvent($input,"blur",function(){e.hide()});f.addEvent($input,"keyup",function(){e.setSelected(this.value)});e.subscribe("change",function(){$input.value=e.getSelected()})};p.Input.prototype=f.merge(p.prototype,
{defaults:f.merge(p.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",offsetLeft:0,offsetTop:0}),classes:f.merge(p.prototype.classes,{positioned:"k-floating"}),show:function(){var a=this.container,b=a.style,e=this.input,d=f.getPosition(e);b.display="";switch(opts.side){case "left":b.left=d.left-f.getWidth(a)+this.settings.offsetLeft+"px";b.top=d.top+this.settings.offsetTop+"px";break;case "right":b.left=d.left+f.getWidth(e)+"px";b.top=d.top+this.settings.offsetTop+"px";break;case "top":b.left=
d.left+this.settings.offsetLeft+"px";b.top=d.top-f.getHeight(a)+this.settings.offsetTop+"px";break;default:b.left=d.left+this.settings.offsetLeft+"px",b.top=d.top+f.getHeight(e)+this.settings.offsetTop+"px"}},hide:function(){this.container.style.display="none"}});var z=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,d,f){for(var o=(a=b[a])?a.length:0,m;o--;)if(m=a[o].apply(d,f||[]),"boolean"===typeof m)return m};a.subscribe=function(a,d,f){b[a]||(b[a]=[]);f?b[a].push(d):b[a].unshift(d);
return[a,d]};a.unsubscribe=function(a){for(var d=b[a[0]],a=a[1],f=d?d.length:0;f--;)d[f]===a&&d.splice(f,1)}},l=p.moment=function(a,b){function e(a){this._d=a}function d(a,b){for(var d=a+"";d.length<b;)d="0"+d;return d}function f(b,d,e,g){var r="string"===typeof d,h=r?{}:d;r&&g&&(h[d]=g);d=(h.ms||h.milliseconds||0)+1E3*(h.s||h.seconds||0)+6E4*(h.m||h.minutes||0)+36E5*(h.h||h.hours||0);g=(h.d||h.days||0)+7*(h.w||h.weeks||0);h=(h.M||h.months||0)+12*(h.y||h.years||0);d&&b.setTime(+b+d*e);g&&b.setDate(b.getDate()+
g*e);h&&(d=b.getDate(),b.setDate(1),b.setMonth(b.getMonth()+h*e),b.setDate(Math.min((new a(b.getFullYear(),b.getMonth()+1,0)).getDate(),d)));return b}function o(b){return new a(b[0],b[1]||0,b[2]||1,b[3]||0,b[4]||0,b[5]||0,b[6]||0)}function m(b,f){function w(e){var f;switch(e){case "M":return r+1;case "Mo":return r+1+n(r+1);case "MM":return d(r+1,2);case "MMM":return g.monthsShort[r];case "MMMM":return g.months[r];case "D":return h;case "Do":return h+n(h);case "DD":return d(h,2);case "DDD":return e=
new a(k,r,h),f=new a(k,0,1),~~((e-f)/864E5+1.5);case "DDDo":return e=w("DDD"),e+n(e);case "DDDD":return d(w("DDD"),3);case "d":return v;case "do":return v+n(v);case "ddd":return g.weekdaysShort[v];case "dddd":return g.weekdays[v];case "w":return e=new a(k,r,h-v+5),f=new a(e.getFullYear(),0,4),~~((e-f)/864E5/7+1.5);case "wo":return e=w("w"),e+n(e);case "ww":return d(w("w"),2);case "YY":return d(k%100,2);case "YYYY":return k;case "a":return 11<l?j.pm:j.am;case "A":return 11<l?j.PM:j.AM;case "H":return l;
case "HH":return d(l,2);case "h":return l%12||12;case "hh":return d(l%12||12,2);case "m":return o;case "mm":return d(o,2);case "s":return p;case "ss":return d(p,2);case "zz":case "z":return(b.toString().match(E)||[""])[0].replace(F,"");case "Z":return(0<q?"+":"-")+d(~~(Math.abs(q)/60),2)+":"+d(~~(Math.abs(q)%60),2);case "ZZ":return(0<q?"+":"-")+d(~~(10*Math.abs(q)/6),4);case "L":case "LL":case "LLL":case "LLLL":case "LT":return m(b,g.longDateFormat[e]);default:return e.replace(/(^\[)|(\\)|\]$/g,"")}}
var t=new e(b),r=t.month(),h=t.date(),k=t.year(),v=t.day(),l=t.hours(),o=t.minutes(),p=t.seconds(),q=t.zone(),n=g.ordinal,j=g.meridiem;return f.replace(z,w)}function p(b,e){var d=[0,0,1,0,0,0,0],f=0,r=0,h=!1,l=b.match(A),k=e.match(G),m,n;for(m=0;m<k.length;m++){var j=l[m],q=void 0;switch(k[m]){case "M":case "MM":d[1]=~~j-1;break;case "MMM":case "MMMM":for(q=0;12>q;q++)if(g.monthsParse[q].test(j)){d[1]=q;break}break;case "D":case "DD":case "DDD":case "DDDD":d[2]=~~j;break;case "YY":j=~~j;d[0]=j+(70<
j?1900:2E3);break;case "YYYY":d[0]=~~Math.abs(j);break;case "a":case "A":n="pm"===j.toLowerCase();break;case "H":case "HH":case "h":case "hh":d[3]=~~j;break;case "m":case "mm":d[4]=~~j;break;case "s":case "ss":d[5]=~~j;break;case "Z":case "ZZ":h=!0,q=j.match(H),q[1]&&(f=~~q[1]),q[2]&&(r=~~q[2]),"-"===q[0]&&(f=-f,r=-r)}}n&&12>d[3]&&(d[3]+=12);!1===n&&12===d[3]&&(d[3]=0);d[3]+=f;d[4]+=r;return h?new a(a.UTC.apply({},d)):o(d)}function n(a,b,d){var e=g.relativeTime[a];return"function"===typeof e?e(b||
1,!!d,a):e.replace(/%d/i,b||1)}function k(a,b){g.fn[a]=function(a){return null!=a?(this._d["set"+b](a),this):this._d["get"+b]()}}var g,l=Math.round,s={},y="undefined"!==typeof module,D="months,monthsShort,monthsParse,weekdays,weekdaysShort,longDateFormat,calendar,relativeTime,ordinal,meridiem".split(","),u,z=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|dddd?|do?|w[o|w]?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|zz?|ZZ?|LT|LL?L?L?)/g,F=/[^A-Z]/g,E=/\([A-Za-z ]+\)|:[0-9]{2} [A-Z]{3} /g,G=/(\\)?(MM?M?M?|dd?d?d|DD?D?D?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|ZZ?|T)/g,
A=/(\\)?([0-9]+|([a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+|([\+\-]\d\d:?\d\d))/gi,H=/([\+\-]|\d\d)/gi,B="Month,Date,Hours,Minutes,Seconds,Milliseconds".split(",");g=function(d,f){if(null===d)return null;var g;if(d&&d._d instanceof a)g=new a(+d._d);else if(f)if("[object Array]"===Object.prototype.toString.call(f)){var j=d.match(A),r=99,h,k,l;for(h=0;h<f.length;h++){k=p(d,f[h]);l=j;for(var n=m(k,f[h]).match(A),s=Math.min(l.length,n.length),u=Math.abs(l.length-n.length),q=0,x=void 0,x=0;x<s;x++)~~l[x]!==
~~n[x]&&q++;l=q+u;l<r&&(r=l,g=k)}}else g=p(d,f);else g=d===b?new a:d instanceof a?d:"[object Array]"===Object.prototype.toString.call(d)?o(d):new a(d);return new e(g)};g.version="1.3.0";g.lang=function(a,b){var d,e;e=[];if(b){for(d=0;12>d;d++)e[d]=RegExp("^"+b.months[d]+"|^"+b.monthsShort[d].replace(".",""),"i");b.monthsParse=b.monthsParse||e;s[a]=b}if(s[a])for(d=0;d<D.length;d++)e=D[d],g[e]=s[a][e]||g[e];else y&&(d=require("./lang/"+a),g.lang(a,d))};g.lang("en",{months:"January,February,March,April,May,June,July,August,September,October,November,December".split(","),
monthsShort:"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(","),weekdays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(","),weekdaysShort:"Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(","),longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},meridiem:{AM:"AM",am:"am",PM:"PM",pm:"pm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",
sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(a){var b=a%10;return 1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th"}});g.fn=e.prototype={clone:function(){return g(this)},valueOf:function(){return+this._d},nativeDate:function(){return this._d},toString:function(){return this._d.toString()},toDate:function(){return this._d},
format:function(a){return m(this._d,a)},add:function(a,b){this._d=f(this._d,a,1,b);return this},subtract:function(a,b){this._d=f(this._d,a,-1,b);return this},diff:function(a,b,d){var e=g(a),a=this._d-e._d,f=this.year()-e.year(),h=this.month()-e.month(),e=this.day()-e.day(),b="months"===b?12*f+h+e/30:"years"===b?f+h/12:"seconds"===b?a/1E3:"minutes"===b?a/6E4:"hours"===b?a/36E5:"days"===b?a/864E5:"weeks"===b?a/6048E5:"days"===b?a/3600:a;return d?b:l(b)},from:function(a,b){var d=this.diff(a),e=g.relativeTime,
f;f=l(Math.abs(d)/1E3);var h=l(f/60),k=l(h/60),j=l(k/24),m=l(j/365);f=45>f&&["s",f]||1===h&&["m"]||45>h&&["mm",h]||1===k&&["h"]||22>k&&["hh",k]||1===j&&["d"]||25>=j&&["dd",j]||45>=j&&["M"]||345>j&&["MM",l(j/30)]||1===m&&["y"]||["yy",m];f[2]=b;f=n.apply({},f);return b?f:(0>=d?e.past:e.future).replace(/%s/i,f)},fromNow:function(a){return this.from(g(),a)},calendar:function(){var a=g(),a=this.diff(g([a.year(),a.month(),a.date()]),"days",!0),b=g.calendar,d=b.sameElse,a=-6>a?d:-1>a?b.lastWeek:0>a?b.lastDay:
1>a?b.sameDay:2>a?b.nextDay:7>a?b.nextWeek:d;return this.format("function"===typeof a?a.apply(this):a)},isLeapYear:function(){var a=this.year();return 0===a%4&&0!==a%100||0===a%400},isDST:function(){return this.zone()!==g([this.year()]).zone()},day:function(a){var b=this._d.getDay();return null==a?b:this.add({d:a-b})}};for(u=0;u<B.length;u++)k(B[u].toLowerCase(),B[u]);k("year","FullYear");g.fn.zone=function(){return this._d.getTimezoneOffset()};return g}(Date)})();
