/********************************************************************
 *	Kalendae, a framework agnostic javascript date picker           *
 *	Copyright(c) 2012 Jarvis Badgley (chipersoft@gmail.com)         *
 *	http://github.com/ChiperSoft/Kalendae                           *
 *	Version 0.1                                                     *
 ********************************************************************/

(function(){var p=function(a){var b=this,d=b.classes,e=b.settings=f.merge(b.defaults,a),a=b.container=f.make("div",{"class":d.container}),k=b.calendars=[],o=l().day(e.weekStart),m,p=[],n,h,g;n=[];var t;h=0;m=e.months;for(h=7;h--;)p.push(o.format("ddd").substr(0,e.columnHeaderLength)),o.add("days",1);z(b);if("object"===typeof e.subscribe)for(h in e.subscribe)e.subscribe.hasOwnProperty(h)&&b.subscribe(h,e.subscribe[h]);b._sel=[];e.selected&&b.setSelected(e.selected,!1);m=e.viewStartDate?l(e.viewStartDate,
e.format):0<b._sel.length?l(b._sel[0]):l();b.viewStartDate=m.date(1);if("function"===typeof e.blackout)b.blackout=e.blackout;else if(e.blackout){var u=y(e.blackout,e.parseSplitDelimiter);b.blackout=function(a){a=l(a).hours(0).minutes(0).seconds(0).valueOf();if(1>a||!b._sel||1>b._sel.length)return!1;for(var d=u.length;d--;)if(u[d].valueOf()===a)return!0;return!1}}else b.blackout=function(){return!1};for(m=Math.max(e.months,1);m--;){n=f.make("div",{"class":d.calendar},a);n.setAttribute("data-cal-index",
m);1<e.months&&(m==Math.max(e.months-1,1)?f.addClassName(n,d.monthFirst):0===m?f.addClassName(n,d.monthLast):f.addClassName(n,d.monthMiddle));h=f.make("div",{"class":d.title},n);f.make("a",{"class":d.previous},h);f.make("a",{"class":d.next},h);o=f.make("span",{"class":d.caption},h);g=f.make("div",{"class":d.header},n);h=0;do t=f.make("span",{},g),t.innerHTML=p[h];while(7>++h);g=f.make("div",{"class":d.days},n);h=0;for(n=[];42>h++;)n.push(f.make("span",{},g));k.push({caption:o,days:n});m&&f.make("div",
{"class":d.monthSeparator},a)}b.draw();f.addEvent(a,"mousedown",function(a,k){var g;if(f.hasClassName(k,d.next))!1!==b.publish("view-changed",b,["next"])&&(b.viewStartDate.add("months",1),b.draw());else if(f.hasClassName(k,d.previous))!1!==b.publish("view-changed",b,["previous"])&&(b.viewStartDate.subtract("months",1),b.draw());else if(f.hasClassName(k.parentNode,d.days)&&f.hasClassName(k,d.dayActive)&&(g=k.getAttribute("data-date")))if(g=l(g,e.dayAttributeFormat),!1!==b.publish("date-clicked",b,
[g]))switch(e.mode){case "multiple":b.addSelected(g)||b.removeSelected(g);break;case "range":b.addSelected(g);break;default:b.addSelected(g)}return!1});(e.attachTo=f.$(e.attachTo))&&e.attachTo.appendChild(a)};p.prototype={defaults:{attachTo:null,months:1,weekStart:0,direction:"any",viewStartDate:null,blackout:null,selected:null,mode:"single",format:null,subscribe:null,columnHeaderLength:2,titleFormat:"MMMM, YYYY",dayNumberFormat:"D",dayAttributeFormat:"YYYY-MM-DD",parseSplitDelimiter:/,\s*|\s*-\s*/,
rangeDelimiter:" - ",multipleDelimiter:", ",dateClassMap:{}},classes:{container:"kalendae",calendar:"k-calendar",monthFirst:"k-first-month",monthMiddle:"k-middle-month",monthLast:"k-last-month",title:"k-title",previous:"k-previous",next:"k-next",caption:"k-caption",header:"k-header",days:"k-days",dayOutOfMonth:"k-out-of-month",dayActive:"k-active",daySelected:"k-selected",dayInRange:"k-range",dayToday:"k-today",monthSeparator:"k-separator"},getSelectedAsDates:function(){for(var a=[],b=0,d=this._sel.length;b<
d;b++)a.push(this._sel[b].nativeDate());return a},getSelectedAsText:function(a){for(var b=[],d=0,e=this._sel.length;d<e;d++)b.push(this._sel[d].format(a||this.settings.format||"YYYY-MM-DD"));return b},getSelectedRaw:function(){for(var a=[],b=0,d=this._sel.length;b<d;b++)a.push(l(this._sel[b]));return a},getSelected:function(a){a=this.getSelectedAsText(a);switch(this.settings.mode){case "range":return a.splice(2),a.join(this.settings.rangeDelimiter);case "multiple":return a.join(this.settings.multipleDelimiter);
default:return a[0]}},isSelected:function(a){a=l(a).hours(0).minutes(0).seconds(0).valueOf();if(1>a||!this._sel||1>this._sel.length)return!1;switch(this.settings.mode){case "range":var b=this._sel[0]?this._sel[0].valueOf():0,d=this._sel[1]?this._sel[1].valueOf():0;if(b===a||d===a)return 1;if(!b||!d)return 0;if(a>b&&a<d||b<d&&a<b&&a>d)return-1;break;case "multiple":for(b=this._sel.length;b--;)if(this._sel[b].valueOf()===a)return!0;break;default:return this._sel[0]&&this._sel[0].valueOf()===a}return!1},
setSelected:function(a,b){this._sel=y(a,this.settings.parseSplitDelimiter);this._sel.sort(function(a,b){return a.valueOf()-b.valueOf()});!1!==b&&this.draw()},addSelected:function(a,b){a=l(a).hours(0).minutes(0).seconds(0);switch(this.settings.mode){case "multiple":if(this.isSelected(a))return!1;this._sel.push(a);break;case "range":1!==this._sel.length?this._sel=[a]:a.valueOf()>this._sel[0].valueOf()?this._sel[1]=a:this._sel=[a,this._sel[0]];break;default:this._sel=[a]}this._sel.sort(function(a,b){return a.valueOf()-
b.valueOf()});this.publish("change",this);!1!==b&&this.draw();return!0},removeSelected:function(a,b){for(var a=l(a).hours(0).minutes(0).seconds(0).valueOf(),d=this._sel.length;d--;)if(this._sel[d].valueOf()===a)return this._sel.splice(d,1),this.publish("change",this),!1!==b&&this.draw(),!0;return!1},draw:function(){var a=l(this.viewStartDate),b,d=l().hours(0).minutes(0).seconds(0),e=this.classes,k,f,m,p=0,n,h=0,g,t=this.settings;n=this.calendars.length;do{b=l(a).date(1).day(this.settings.weekStart);
k=this.calendars[p];k.caption.innerHTML=a.format(this.settings.titleFormat);h=0;do f=k.days[h],m=[],(g=this.isSelected(b))&&m.push({"-1":e.dayInRange,1:e.daySelected,"true":e.daySelected}[g]),b.month()!=a.month()?m.push(e.dayOutOfMonth):(!this.blackout(b)||0<g)&&m.push(e.dayActive),0===Math.floor(d.diff(b,"days",!0))&&m.push(e.dayToday),g=b.format(this.settings.dayAttributeFormat),t.dateClassMap[g]&&m.push(t.dateClassMap[g]),f.innerHTML=b.format(t.dayNumberFormat),f.className=m.join(" "),f.setAttribute("data-date",
g),b.add("days",1);while(42>++h);a.add("months",1)}while(++p<n)}};var y=function(a,b){var d=[];"string"===typeof a?a=a.split(b):unit.isArray(a)||(a=[sel_in]);c=a.length;i=0;do d.push(l(a[i]).hours(0).minutes(0).seconds(0));while(++i<c);return d};window.Kalendae=p;"undefined"!==typeof jQuery&&(jQuery.fn.kalendae=function(a){this.each(function(b,d){var e=$(d);e.is("input")?e.data("kalendae",new p.Input(d,a)):e.data("kalendae",new p($.extend({},{attachTo:d},a)))});return this});var f={$:function(a){return typeof a==
"string"?document.getElementById(a):a},make:function(a,b,d){var e,a=document.createElement(a);if(b)for(e in b)b.hasOwnProperty(e)&&a.setAttribute(e,b[e]);d&&d.appendChild(a);return a},isVisible:function(a){return a.offsetWidth>0||a.offsetHeight>0},addEvent:function(a,b,d){var e=function(b){var b=b||window.event,e=d.apply(a,[b,b.target||b.srcElement]);if(e===false)if(b.preventDefault)b.preventDefault();else{b.returnValue=false;b.cancelBubble=true}return e};a.attachEvent?a.attachEvent("on"+b,e):a.addEventListener(b,
e,false);return e},removeEvent:function(a,b,d){a.detachEvent?a.detachEvent("on"+b,d):a.removeEventListener(b,d,false)},hasClassName:function(a,b){if(!(a=f.$(a)))return false;var d=a.className;return d.length>0&&(d==b||RegExp("(^|\\s)"+b+"(\\s|$)").test(d))},addClassName:function(a,b){if((a=f.$(a))&&!f.hasClassName(a,b))a.className=a.className+((a.className?" ":"")+b)},removeClassName:function(a,b){if(a=f.$(a))a.className=f.trimString(a.className.replace(RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},getPosition:function(a,
b){var d=a.offsetLeft,e=a.offsetTop,f={};if(!b)for(;a=a.offsetParent;){d=d+a.offsetLeft;e=e+a.offsetTop}f[0]=f.left=d;f[1]=f.top=e;return f},getHeight:function(a){return a.offsetHeight||a.scrollHeight},getWidth:function(a){return a.offsetWidth||a.scrollWidth},trimString:function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},merge:function(){for(var a=arguments[0]===true,b={},d=a?1:0;d<arguments.length;d++){var e=b,f=arguments[d];if(typeof f==="object"){var o=void 0;for(o in f)f.hasOwnProperty(o)&&
(a&&typeof e[o]==="object"&&typeof f[o]==="object"?_update(e[o],f[o]):e[o]=f[o])}}return b},isArray:function(a){return!(!a||!a.length||a.length===0||typeof a!=="object"||!a.constructor||a.nodeType||a.item)}};p.Input=function(a,b){this.input=$input=f.$(a);if(!$input||$input.tagName!=="INPUT")throw"First argument for Kalendae.Input must be an <input> element or a valid element id.";var d=this,e=d.classes;opts=d.settings=f.merge(d.defaults,b);opts.attachTo=window.document.body;if(!opts.selected)opts.selected=
$input.value;p.call(d,opts);var k=d.container,o=false;k.style.display="none";f.addClassName(k,e.positioned);f.addEvent(k,"mousedown",function(){o=true});f.addEvent(window.document,"mousedown",function(){o=false});f.addEvent($input,"focus",function(){d.setSelected(this.value);d.show()});f.addEvent($input,"blur",function(){if(o){o=false;$input.focus()}else d.hide()});f.addEvent($input,"keyup",function(){d.setSelected(this.value)});d.subscribe("change",function(){$input.value=d.getSelected()})};p.Input.prototype=
f.merge(p.prototype,{defaults:f.merge(p.prototype.defaults,{format:"MM/DD/YYYY",side:"bottom",offsetLeft:0,offsetTop:0}),classes:f.merge(p.prototype.classes,{positioned:"k-floating"}),show:function(){var a=this.container,b=a.style,d=this.input,e=f.getPosition(d);b.display="";switch(opts.side){case "left":b.left=e.left-f.getWidth(a)+this.settings.offsetLeft+"px";b.top=e.top+this.settings.offsetTop+"px";break;case "right":b.left=e.left+f.getWidth(d)+"px";b.top=e.top+this.settings.offsetTop+"px";break;
case "top":b.left=e.left+this.settings.offsetLeft+"px";b.top=e.top-f.getHeight(a)+this.settings.offsetTop+"px";break;default:b.left=e.left+this.settings.offsetLeft+"px";b.top=e.top+f.getHeight(d)+this.settings.offsetTop+"px"}},hide:function(){this.container.style.display="none"}});var z=function(a){a||(a=this);var b=a.c_||{};a.publish=function(a,e,f){for(var o=(a=b[a])?a.length:0,m;o--;){m=a[o].apply(e,f||[]);if(typeof m==="boolean")return m}};a.subscribe=function(a,e,f){b[a]||(b[a]=[]);f?b[a].push(e):
b[a].unshift(e);return[a,e]};a.unsubscribe=function(a){for(var e=b[a[0]],a=a[1],f=e?e.length:0;f--;)e[f]===a&&e.splice(f,1)}},l=p.moment=function(a,b){function d(a){this._d=a}function e(a,b){for(var e=a+"";e.length<b;)e="0"+e;return e}function f(b,e,d,g){var r=typeof e==="string",j=r?{}:e;r&&g&&(j[e]=g);e=(j.ms||j.milliseconds||0)+(j.s||j.seconds||0)*1E3+(j.m||j.minutes||0)*6E4+(j.h||j.hours||0)*36E5;g=(j.d||j.days||0)+(j.w||j.weeks||0)*7;j=(j.M||j.months||0)+(j.y||j.years||0)*12;e&&b.setTime(+b+
e*d);g&&b.setDate(b.getDate()+g*d);if(j){e=b.getDate();b.setDate(1);b.setMonth(b.getMonth()+j*d);b.setDate(Math.min((new a(b.getFullYear(),b.getMonth()+1,0)).getDate(),e))}return b}function o(b){return new a(b[0],b[1]||0,b[2]||1,b[3]||0,b[4]||0,b[5]||0,b[6]||0)}function m(b,f){function x(d){var f;switch(d){case "M":return r+1;case "Mo":return r+1+n(r+1);case "MM":return e(r+1,2);case "MMM":return g.monthsShort[r];case "MMMM":return g.months[r];case "D":return j;case "Do":return j+n(j);case "DD":return e(j,
2);case "DDD":d=new a(o,r,j);f=new a(o,0,1);return~~((d-f)/864E5+1.5);case "DDDo":d=x("DDD");return d+n(d);case "DDDD":return e(x("DDD"),3);case "d":return w;case "do":return w+n(w);case "ddd":return g.weekdaysShort[w];case "dddd":return g.weekdays[w];case "w":d=new a(o,r,j-w+5);f=new a(d.getFullYear(),0,4);return~~((d-f)/864E5/7+1.5);case "wo":d=x("w");return d+n(d);case "ww":return e(x("w"),2);case "YY":return e(o%100,2);case "YYYY":return o;case "a":return h>11?k.pm:k.am;case "A":return h>11?k.PM:
k.AM;case "H":return h;case "HH":return e(h,2);case "h":return h%12||12;case "hh":return e(h%12||12,2);case "m":return l;case "mm":return e(l,2);case "s":return p;case "ss":return e(p,2);case "zz":case "z":return(b.toString().match(D)||[""])[0].replace(E,"");case "Z":return(q>0?"+":"-")+e(~~(Math.abs(q)/60),2)+":"+e(~~(Math.abs(q)%60),2);case "ZZ":return(q>0?"+":"-")+e(~~(10*Math.abs(q)/6),4);case "L":case "LL":case "LLL":case "LLLL":case "LT":return m(b,g.longDateFormat[d]);default:return d.replace(/(^\[)|(\\)|\]$/g,
"")}}var v=new d(b),r=v.month(),j=v.date(),o=v.year(),w=v.day(),h=v.hours(),l=v.minutes(),p=v.seconds(),q=v.zone(),n=g.ordinal,k=g.meridiem;return f.replace(z,x)}function p(b,e){var d=[0,0,1,0,0,0,0],f=0,r=0,j=false,h=b.match(A),l=e.match(F),m,n;for(m=0;m<l.length;m++){var k=h[m],q=void 0;switch(l[m]){case "M":case "MM":d[1]=~~k-1;break;case "MMM":case "MMMM":for(q=0;q<12;q++)if(g.monthsParse[q].test(k)){d[1]=q;break}break;case "D":case "DD":case "DDD":case "DDDD":d[2]=~~k;break;case "YY":k=~~k;d[0]=
k+(k>70?1900:2E3);break;case "YYYY":d[0]=~~Math.abs(k);break;case "a":case "A":n=k.toLowerCase()==="pm";break;case "H":case "HH":case "h":case "hh":d[3]=~~k;break;case "m":case "mm":d[4]=~~k;break;case "s":case "ss":d[5]=~~k;break;case "Z":case "ZZ":j=true;q=k.match(G);q[1]&&(f=~~q[1]);q[2]&&(r=~~q[2]);if(q[0]==="-"){f=-f;r=-r}}}n&&d[3]<12&&(d[3]=d[3]+12);n===false&&d[3]===12&&(d[3]=0);d[3]=d[3]+f;d[4]=d[4]+r;return j?new a(a.UTC.apply({},d)):o(d)}function n(a,b,d){var e=g.relativeTime[a];return typeof e===
"function"?e(b||1,!!d,a):e.replace(/%d/i,b||1)}function h(a,b){g.fn[a]=function(a){if(a!=null){this._d["set"+b](a);return this}return this._d["get"+b]()}}var g,l=Math.round,u={},y=typeof module!=="undefined",C=["months","monthsShort","monthsParse","weekdays","weekdaysShort","longDateFormat","calendar","relativeTime","ordinal","meridiem"],s,z=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|dddd?|do?|w[o|w]?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|zz?|ZZ?|LT|LL?L?L?)/g,E=/[^A-Z]/g,D=/\([A-Za-z ]+\)|:[0-9]{2} [A-Z]{3} /g,
F=/(\\)?(MM?M?M?|dd?d?d|DD?D?D?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|ZZ?|T)/g,A=/(\\)?([0-9]+|([a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+|([\+\-]\d\d:?\d\d))/gi,G=/([\+\-]|\d\d)/gi,B=["Month","Date","Hours","Minutes","Seconds","Milliseconds"];g=function(e,f){if(e===null)return null;var g;if(e&&e._d instanceof a)g=new a(+e._d);else if(f)if(Object.prototype.toString.call(f)==="[object Array]"){var k=e.match(A),r=99,j,h,l;for(j=0;j<f.length;j++){h=p(e,f[j]);l=k;for(var n=m(h,f[j]).match(A),t=Math.min(l.length,
n.length),u=Math.abs(l.length-n.length),q=0,s=void 0,s=0;s<t;s++)~~l[s]!==~~n[s]&&q++;l=q+u;if(l<r){r=l;g=h}}}else g=p(e,f);else g=e===b?new a:e instanceof a?e:Object.prototype.toString.call(e)==="[object Array]"?o(e):new a(e);return new d(g)};g.version="1.3.0";g.lang=function(a,b){var d,e;e=[];if(b){for(d=0;d<12;d++)e[d]=RegExp("^"+b.months[d]+"|^"+b.monthsShort[d].replace(".",""),"i");b.monthsParse=b.monthsParse||e;u[a]=b}if(u[a])for(d=0;d<C.length;d++){e=C[d];g[e]=u[a][e]||g[e]}else if(y){d=require("./lang/"+
a);g.lang(a,d)}};g.lang("en",{months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],weekdaysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},meridiem:{AM:"AM",
am:"am",PM:"PM",pm:"pm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(a){var b=a%10;return~~(a%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th"}});g.fn=d.prototype={clone:function(){return g(this)},
valueOf:function(){return+this._d},nativeDate:function(){return this._d},toString:function(){return this._d.toString()},toDate:function(){return this._d},format:function(a){return m(this._d,a)},add:function(a,b){this._d=f(this._d,a,1,b);return this},subtract:function(a,b){this._d=f(this._d,a,-1,b);return this},diff:function(a,b,d){var e=g(a),a=this._d-e._d,f=this.year()-e.year(),j=this.month()-e.month(),e=this.day()-e.day(),b=b==="months"?f*12+j+e/30:b==="years"?f+j/12:b==="seconds"?a/1E3:b==="minutes"?
a/6E4:b==="hours"?a/36E5:b==="days"?a/864E5:b==="weeks"?a/6048E5:b==="days"?a/3600:a;return d?b:l(b)},from:function(a,b){var d=this.diff(a),e=g.relativeTime,f;f=l(Math.abs(d)/1E3);var j=l(f/60),k=l(j/60),h=l(k/24),m=l(h/365);f=f<45&&["s",f]||j===1&&["m"]||j<45&&["mm",j]||k===1&&["h"]||k<22&&["hh",k]||h===1&&["d"]||h<=25&&["dd",h]||h<=45&&["M"]||h<345&&["MM",l(h/30)]||m===1&&["y"]||["yy",m];f[2]=b;f=n.apply({},f);return b?f:(d<=0?e.past:e.future).replace(/%s/i,f)},fromNow:function(a){return this.from(g(),
a)},calendar:function(){var a=g(),a=this.diff(g([a.year(),a.month(),a.date()]),"days",true),b=g.calendar,d=b.sameElse,a=a<-6?d:a<-1?b.lastWeek:a<0?b.lastDay:a<1?b.sameDay:a<2?b.nextDay:a<7?b.nextWeek:d;return this.format(typeof a==="function"?a.apply(this):a)},isLeapYear:function(){var a=this.year();return a%4===0&&a%100!==0||a%400===0},isDST:function(){return this.zone()!==g([this.year()]).zone()},day:function(a){var b=this._d.getDay();return a==null?b:this.add({d:a-b})}};for(s=0;s<B.length;s++)h(B[s].toLowerCase(),
B[s]);h("year","FullYear");g.fn.zone=function(){return this._d.getTimezoneOffset()};return g}(Date)})();
